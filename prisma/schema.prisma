// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Barbershop {
  id                     String                  @id @default(uuid())
  name                   String
  slug                   String                  @unique
  publicSlug             String                  @unique
  shareSlug              String?                 @unique
  address                String
  description            String
  homePremiumTitle       String                  @default("Experiencia premium na home")
  homePremiumDescription String                  @default("Sua barbearia fica em destaque para todos os acessos em modo exclusivo.")
  homePremiumChips       String[]                @default(["Atendimento personalizado", "Reserva em poucos passos", "Visual profissional"])
  imageUrl               String
  logoUrl                String?
  exclusiveBarber        Boolean                 @default(false)
  phones                 String[]
  plan                   BarbershopPlan          @default(BASIC)
  whatsappProvider       WhatsAppProvider        @default(NONE)
  whatsappFrom           String?
  whatsappEnabled        Boolean                 @default(false)
  bookingIntervalMinutes Int                     @default(30)
  stripeEnabled          Boolean                 @default(true)
  isActive               Boolean                 @default(true)
  ownerId                String?                 @unique
  owner                  User?                   @relation("BarbershopOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  users                  User[]                  @relation("UserBarbershop")
  barbers                Barber[]
  services               BarbershopService[]
  bookings               Booking[]
  openingHours           BarbershopOpeningHours[]
  customerBarbershops    CustomerBarbershop[]
  currentUsers           User[]                  @relation("CurrentBarbershopContext")
  whatsappSettings       BarbershopWhatsAppSettings?
  notificationJobs       NotificationJob[]

}

model AppConfig {
  id String @id @default("app")
}

model BarbershopService {
  id                String     @id @default(uuid())
  name              String
  description       String?
  imageUrl          String?
  priceInCents      Int
  durationInMinutes Int        @default(30)
  isFeatured        Boolean    @default(false)
  barbershopId      String
  barbershop        Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  bookings          Booking[]
  bookingServices   BookingService[]
  deletedAt         DateTime?
}

model Barber {
  id           String     @id @default(uuid())
  name         String
  imageUrl     String?
  barbershopId String
  barbershop   Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  bookings     Booking[]
  createdAt    DateTime   @default(now()) @db.Timestamptz()
  updatedAt    DateTime   @updatedAt @db.Timestamptz()

  @@index([barbershopId])
}

model BarbershopOpeningHours {
  id           String     @id @default(uuid())
  barbershopId String
  dayOfWeek    Int
  openMinute   Int
  closeMinute  Int
  closed       Boolean    @default(false)
  barbershop   Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)

  @@index([barbershopId])
  @@unique([barbershopId, dayOfWeek])
}

model Booking {
  id             String            @id @default(uuid())
  stripeSessionId String?          @unique
  stripeChargeId String?
  paymentMethod  PaymentMethod     @default(IN_PERSON)
  paymentStatus  PaymentStatus     @default(PENDING)
  barbershopId   String
  barbershop     Barbershop        @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  barberId       String?
  barber         Barber?           @relation(fields: [barberId], references: [id], onDelete: SetNull)
  serviceId      String
  service        BarbershopService @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  services       BookingService[]
  userId         String
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  totalDurationMinutes Int?
  totalPriceInCents   Int?
  startAt        DateTime?         @db.Timestamptz()
  endAt          DateTime?         @db.Timestamptz()
  paymentConfirmedAt DateTime?     @db.Timestamptz()
  date           DateTime          @db.Timestamptz()
  cancelledAt    DateTime?         @db.Timestamptz()
  createdAt      DateTime          @default(now()) @db.Timestamptz()
  updatedAt      DateTime          @updatedAt @db.Timestamptz()
  notificationJobs NotificationJob[]

  @@index([barberId])
  @@index([startAt])
  @@index([barbershopId, date, cancelledAt])
  @@index([barbershopId, paymentStatus, createdAt])
  @@index([userId, date])
}

model BookingService {
  bookingId String
  serviceId String
  booking   Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  service   BarbershopService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([bookingId, serviceId])
  @@index([serviceId])
}

model BarbershopWhatsAppSettings {
  id                      String     @id @default(uuid())
  barbershopId            String     @unique
  sendBookingConfirmation Boolean    @default(true)
  sendReminder24h         Boolean    @default(true)
  sendReminder1h          Boolean    @default(true)
  createdAt               DateTime   @default(now()) @db.Timestamptz()
  updatedAt               DateTime   @updatedAt @db.Timestamptz()
  barbershop              Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
}

model NotificationJob {
  id           String                @id @default(uuid())
  barbershopId String
  bookingId    String
  type         NotificationJobType
  scheduledAt  DateTime              @db.Timestamptz()
  status       NotificationJobStatus @default(PENDING)
  attempts     Int                   @default(0)
  lastError    String?
  sentAt       DateTime?             @db.Timestamptz()
  canceledAt   DateTime?             @db.Timestamptz()
  cancelReason String?
  createdAt    DateTime              @default(now()) @db.Timestamptz()
  updatedAt    DateTime              @updatedAt @db.Timestamptz()
  barbershop   Barbershop            @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  booking      Booking               @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([status, scheduledAt])
  @@index([bookingId])
  @@index([barbershopId])
  @@unique([bookingId, type])
}

enum PaymentMethod {
  STRIPE
  IN_PERSON
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum BarbershopPlan {
  BASIC
  PRO
}

enum WhatsAppProvider {
  NONE
  TWILIO
}

enum NotificationJobType {
  BOOKING_CONFIRM
  REMINDER_24H
  REMINDER_1H
}

enum NotificationJobStatus {
  PENDING
  SENDING
  SENT
  FAILED
  CANCELED
}

enum UserRole {
  CUSTOMER
  OWNER
  ADMIN
}

model User {
  id                 String                @id
  name               String
  email              String
  provider           String                @default("credentials")
  contactEmail       String?               @unique
  phone              String?               @unique
  phoneVerified      Boolean               @default(false)
  phoneVerifiedAt    DateTime?
  profileCompleted   Boolean               @default(false)
  emailVerified      Boolean               @default(false)
  image              String?
  role               UserRole              @default(CUSTOMER)
  isActive           Boolean               @default(true)
  barbershopId       String?
  barbershop         Barbershop?           @relation("UserBarbershop", fields: [barbershopId], references: [id], onDelete: SetNull)
  currentBarbershopId String?
  currentBarbershop  Barbershop?           @relation("CurrentBarbershopContext", fields: [currentBarbershopId], references: [id], onDelete: SetNull)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  sessions           Session[]
  accounts           Account[]
  bookings           Booking[]
  ownedBarbershop    Barbershop?           @relation("BarbershopOwner")
  customerBarbershops CustomerBarbershop[]

  @@unique([email])
  @@unique([name, phone])
  @@index([barbershopId])
  @@index([currentBarbershopId])
  @@map("user")
}

model CustomerBarbershop {
  id           String     @id @default(uuid())
  customerId   String
  barbershopId String
  createdAt    DateTime   @default(now())
  customer     User       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  barbershop   Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)

  @@unique([customerId, barbershopId])
  @@index([customerId])
  @@index([barbershopId])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}
